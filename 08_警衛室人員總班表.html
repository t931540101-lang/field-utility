<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K9 è­¦è¡›è¼ªç­ç¸½ç®¡ç†ç³»çµ±</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --primary: #d32f2f; --bg: #f0f2f5; --border: #ccc; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 15px; }
        .header-box { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .month-ctrl { display: flex; align-items: center; gap: 20px; font-weight: 900; font-size: 1.4rem; color: #2c3e50; }
        .btn-nav { padding: 8px 18px; cursor: pointer; background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; transition: 0.2s; }
        .btn-nav:hover { background: #e9ecef; }
        .lock-btn { padding: 10px 20px; border-radius: 30px; border: none; background: #607d8b; color: white; cursor: pointer; font-weight: bold; }
        .lock-btn.unlocked { background: #43a047; box-shadow: 0 0 12px rgba(67,160,71,0.4); }
        
        /* æ ¸å¿ƒï¼šé›»è…¦ç‰ˆå¯¬åº¦æ§åˆ¶ */
        .table-container { width: 100%; overflow-x: auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border: 1px solid #eee; }
        table { border-collapse: collapse; min-width: 1800px; width: 100%; table-layout: fixed; } /* å›ºå®šä½ˆå±€é˜²æ­¢æ‹‰ä¼¸ */
        th, td { border: 1px solid var(--border); padding: 8px 0; text-align: center; font-size: 13px; }
        th { background: #fdfcf9; color: #555; height: 40px; }
        
        /* é–å®šå§“åèˆ‡çµ„åˆ¥ */
        .sticky-left { position: sticky; left: 0; background: #fff !important; z-index: 5; border-right: 2px solid #999 !important; width: 50px; }
        .sticky-left-2 { position: sticky; left: 50px; background: #fff !important; z-index: 5; border-right: 2px solid #ccc !important; width: 80px; }
        
        input { width: 100%; border: none; text-align: center; font-size: 13px; background: transparent; pointer-events: none; font-weight: 700; outline: none; }
        .can-edit input { pointer-events: auto; background: #fffde7; }
        
       <style>
    /* ... ä¹‹å‰çš„æ¨£å¼ ... */
    .val-æ—¥ { color: #0d47a1; background: #e3f2fd; }
    .val-å¤œ { color: #4a148c; background: #f3e5f5; }
    .val-ä¼‘, .val-ä¾‹, .val-âŒ { color: #b71c1c; background: #ffebee; }
    /* ç‰¹ä¼‘å°ˆå±¬é…è‰²ï¼šæ·±é»ƒå­— + æ·ºé»ƒåº• */
    .val-ç‰¹ { color: #f57f17; background: #fffde7; } 
    /* ... ä¹‹å¾Œçš„æ¨£å¼ ... */
</style>
</head>
<body>

<div class="header-box">
    <div class="month-ctrl">
        <button class="btn-nav" onclick="changeMonth(-1)">â®</button>
        <span id="currentMonthDisplay">è¼‰å…¥ä¸­...</span>
        <button class="btn-nav" onclick="changeMonth(1)">â¯</button>
    </div>
    <button id="lockBtn" class="lock-btn" onclick="toggleLock()">ğŸ”’ å”¯è®€æ¨¡å¼</button>
</div>

<div class="table-container">
    <table id="rosterTable">
        <thead>
            <tr id="dateHeader"></tr>
            <tr id="weekHeader"></tr>
        </thead>
        <tbody id="rosterBody"></tbody>
    </table>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB2_tKKsVT4kdW7PPkJgI9O7S1YdCWor48",
        databaseURL: "https://factor-security-d1965-default-rtdb.firebaseio.com",
        projectId: "factor-security-d1965",
        appId: "1:864846943143:web:4cfa18cd20d2f712225c82"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let curYear = 2026;
    let curMonth = 2; // é è¨­è·³åˆ° 3 æœˆæ¸¬è©¦
    let isEditing = false;
    const staffData = [
        {group: "ç¸½å‹™", name: "ç›§å®¶æ…¶"}, {group: "ç¸½å‹™", name: "ä½•é´»éš†"},
        {group: "ç¸½å‹™", name: "è”¡æ˜“å€«"}, {group: "ç¸½å‹™", name: "é‚±é´»éˆ"},
        {group: "ç¸½å‹™", name: "æŸ³æ—­æ´²"}, {group: "ç¸½å‹™", name: "é­æ¦®å¿—"},
        {group: "ç¸½å‹™", name: ""}
    ];
    const weekNames = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"];

    function initTable() {
        const dHead = document.getElementById('dateHeader');
        const wHead = document.getElementById('weekHeader');
        const tbody = document.getElementById('rosterBody');
        
        dHead.innerHTML = `<th class="sticky-left">çµ„åˆ¥</th><th class="sticky-left-2">å§“å</th>`;
        wHead.innerHTML = `<th class="sticky-left">-</th><th class="sticky-left-2">-</th>`;
        tbody.innerHTML = '';

        document.getElementById('currentMonthDisplay').innerText = `${curYear}å¹´ ${curMonth + 1}æœˆ`;
        const daysInMonth = new Date(curYear, curMonth + 1, 0).getDate();

        for (let d = 1; d <= daysInMonth; d++) {
            const dateTh = document.createElement('th');
            dateTh.innerText = d;
            dHead.appendChild(dateTh);

            const dayOfWeek = weekNames[new Date(curYear, curMonth, d).getDay()];
            const weekTh = document.createElement('th');
            weekTh.innerText = dayOfWeek;
            if(dayOfWeek === "æ—¥" || dayOfWeek === "å…­") weekTh.className = "weekend";
            wHead.appendChild(weekTh);
        }
        
        ["æ—¥", "å¤œ", "ä¼‘"].forEach(t => {
            const th = document.createElement('th'); th.className = "summary-col"; th.innerText = t;
            dHead.appendChild(th);
            wHead.appendChild(document.createElement('th'));
        });

        staffData.forEach(p => {
            const tr = document.createElement('tr');
            let rowHtml = `<td class="sticky-left">${p.group}</td><td class="sticky-left-2"><b>${p.name}</b></td>`;
            for (let d = 1; d <= daysInMonth; d++) {
                rowHtml += `<td><input id="${curYear}_${curMonth+1}_${p.name}_${d}" onchange="saveShift('${p.name}', ${d}, this.value)"></td>`;
            }
            rowHtml += `<td id="sd_${p.name}" class="summary-col">0</td><td id="sn_${p.name}" class="summary-col">0</td><td id="so_${p.name}" class="summary-col">0</td>`;
            tr.innerHTML = rowHtml;
            tbody.appendChild(tr);
        });

        listenToData(daysInMonth);
    }

    function listenToData(days) {
        db.ref('guardSchedules').off();
        db.ref('guardSchedules').on('value', (snapshot) => {
            const data = snapshot.val() || {};
            staffData.forEach(p => {
                let dc=0, nc=0, oc=0;
                for (let d = 1; d <= days; d++) {
                    const id = `${curYear}_${curMonth+1}_${p.name}_${d}`;
                    const val = data[id] || "";
                    const el = document.getElementById(id);
                    if(el) {
                        el.value = val;
                        el.className = "";
                        if(val) el.classList.add('val-' + val.substring(0,1));
                        if(val.includes("æ—¥")) dc++; 
                        else if(val.includes("å¤œ")) nc++; 
                        else if(val!=="") oc++;
                    }
                }
                document.getElementById(`sd_${p.name}`).innerText = dc;
                document.getElementById(`sn_${p.name}`).innerText = nc;
                document.getElementById(`so_${p.name}`).innerText = oc;
            });
        });
    }

    function saveShift(name, day, val) {
        const id = `${curYear}_${curMonth+1}_${name}_${day}`;
        db.ref('guardSchedules/' + id).set(val);
    }

    function changeMonth(dir) {
        curMonth += dir;
        if (curMonth < 0) { curMonth = 11; curYear--; }
        else if (curMonth > 11) { curMonth = 0; curYear++; }
        initTable();
    }

    function toggleLock() {
        if(!isEditing && prompt("äººäº‹å¯†ç¢¼ï¼š") === "8888") {
            isEditing = true; document.body.classList.add('can-edit');
            document.getElementById('lockBtn').innerText = "ğŸ”“ ç·¨è¼¯ä¸­"; document.getElementById('lockBtn').classList.add('unlocked');
        } else if(isEditing) {
            isEditing = false; document.body.classList.remove('can-edit');
            document.getElementById('lockBtn').innerText = "ğŸ”’ å”¯è®€æ¨¡å¼"; document.getElementById('lockBtn').classList.remove('unlocked');
        }
    }

    initTable();
</script>
</body>
</html>
