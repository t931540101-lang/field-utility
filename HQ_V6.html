<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-SECURITY | HQ æ——è‰¦çµ‚ç«¯ V6.7</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        :root { --main-cyan: #00f2ff; --warn-red: #ff4d4f; --bg-dark: #050505; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-dark); color: white; margin: 0; }
        
        .medical-card { background: #111; border: 1px solid #333; border-radius: 8px; }
        .stamp-red { border: 2px solid #ef4444; color: #ef4444; transform: rotate(-5deg); font-weight: 900; padding: 2px 8px; border-radius: 4px; display: inline-block; font-size: 10px; }
        .duty-card { background: #1a1a1a; border-left: 6px solid var(--main-cyan); }
        .confirmed-card { background: #064e3b; border-left-color: #10b981; opacity: 0.8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyB2_tKKsVT4kdW7PPkJgI9O7S1YdCWor48",
            authDomain: "factor-security-d1965.firebaseapp.com",
            databaseURL: "https://factor-security-d1965-default-rtdb.firebaseio.com",
            projectId: "factor-security-d1965",
            storageBucket: "factor-security-d1965.firebasestorage.app",
            messagingSenderId: "864846943143",
            appId: "1:864846943143:web:4cfa18cd20d2f712225c82"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function App() {
            const [activeTab, setActiveTab] = useState('monitor');
            const [logs, setLogs] = useState([]);
            const [visitors, setVisitors] = useState([]);
            const [masterData, setMasterData] = useState([]);
            const [k9Logs, setK9Logs] = useState({});
            
            const [k9List] = useState([
                { id: 'å¸ƒä¸', name: 'å¼µå¸ƒä¸', weight: '43.5' },
                { id: 'å°ç™½', name: 'è”¡å°ç™½', weight: '23.5' },
                { id: 'å°èŠ±', name: 'è”¡å°èŠ±', weight: '23.3' },
                { id: 'ä¾†é †', name: 'ä¾†é †', weight: '25.2' },
                { id: 'ç“œç“œ', name: 'å“ˆèœœç“œ', weight: '24.5' },
                { id: 'è²´è²´', name: 'è”¡é ­è²´', weight: '25.1' },
                { id: 'è”¡å“º', name: 'è”¡å“º', weight: '23.3' },
                { id: 'æœ‰éŒ¢', name: 'æœ‰éŒ¢', weight: '25.6' }
            ]);

            useEffect(() => {
                db.ref('reactLogs').on('value', snap => {
                    const data = snap.val();
                    if (data) setLogs(Object.keys(data).map(k => ({ id: k, ...data[k] })).sort((a,b) => b.timestamp - a.timestamp));
                });

                db.ref('k9Logs').on('value', snap => { setK9Logs(snap.val() || {}); });

                db.ref('visitor_logs').on('value', snap => {
                    const data = snap.val();
                    if (data) setVisitors(Object.keys(data).map(k => ({ id: k, ...data[k] })).reverse());
                });

                const refreshMaster = async () => {
                    const [emp, black, vip] = await Promise.all([
                        db.ref('employee_list').once('value'),
                        db.ref('blacklist_data').once('value'),
                        db.ref('vip_vehicles').once('value')
                    ]);
                    let combined = [];
                    if(emp.val()) Object.keys(emp.val()).forEach(k => combined.push({type:'EMP', id:k, ...emp.val()[k]}));
                    if(black.val()) Object.keys(black.val()).forEach(k => combined.push({type:'BLACK', id:k, ...black.val()[k]}));
                    if(vip.val()) Object.keys(vip.val()).forEach(k => combined.push({type:'VIP', id:k, ...vip.val()[k]}));
                    setMasterData(combined);
                };
                db.ref('employee_list').on('value', refreshMaster);
                
                return () => db.ref('reactLogs').off();
            }, []);

            const addK9Log = (dogId, dogName) => {
                const note = prompt(`ç‚º ${dogName} è¼¸å…¥ä»Šæ—¥ç´€éŒ„ï¼š`);
                if (!note) return;
                db.ref(`k9Logs/${dogId}`).push({
                    time: new Date().toLocaleString(), note, timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            };

            const TabBtn = ({id, label}) => (
                <button onClick={() => setActiveTab(id)} 
                    className={`flex-1 py-3 text-xs font-black uppercase transition-all ${activeTab === id ? 'text-cyan-400 border-b-2 border-cyan-400 bg-neutral-800' : 'text-gray-500'}`}>
                    {label}
                </button>
            );

            return (
                <div className="min-h-screen flex flex-col bg-black">
                    <header className="bg-black border-b-2 border-cyan-400 p-4 flex justify-between items-center">
                        <div>
                            <h1 className="text-xl font-black italic tracking-widest text-cyan-400">M-SECURITY HQ</h1>
                            <p className="text-[9px] text-gray-500 font-bold uppercase">Tactical Operations Hub V6.7</p>
                        </div>
                        <div className="stamp-red">ç™¼å°„æˆåŠŸ</div>
                    </header>

                    <nav className="flex bg-neutral-900 border-b border-neutral-800 sticky top-0 z-50">
                        <TabBtn id="monitor" label="ç›£æ§" />
                        <TabBtn id="visitor" label="è¨ªå®¢" />
                        <TabBtn id="handover" label="äº¤æ¥" />
                        <TabBtn id="k9" label="K9æˆ°çŠ¬" />
                        <TabBtn id="manage" label="ç®¡ç†" />
                    </nav>

                    <main className="p-4 flex-1 no-scrollbar overflow-y-auto">
                        {activeTab === 'k9' && (
                            <div className="grid gap-4">
                                {k9List.map(dog => {
                                    const logs = k9Logs[dog.id] ? Object.keys(k9Logs[dog.id]).map(key => ({ key, ...k9Logs[dog.id][key] })).sort((a,b) => b.timestamp - a.timestamp) : [];
                                    return (
                                        <div key={dog.id} className="medical-card p-4">
                                            <div className="flex justify-between items-end mb-2 border-b border-neutral-800 pb-2">
                                                <span className="text-lg font-black text-cyan-400">{dog.name}</span>
                                                <span className="text-[9px] text-gray-500 italic">é«”é‡: {dog.weight} KG</span>
                                            </div>
                                            <div className="space-y-2 mb-3">
                                                {logs.slice(0, 2).map(log => (
                                                    <div key={log.key} className="bg-neutral-800/50 p-2 rounded border-l-2 border-cyan-900 relative">
                                                        <div className="text-[8px] text-gray-600">{log.time}</div>
                                                        <p className="text-xs font-bold text-gray-300">{log.note}</p>
                                                    </div>
                                                ))}
                                            </div>
                                            <button onClick={() => addK9Log(dog.id, dog.name)} className="w-full bg-neutral-800 text-cyan-400 py-1 rounded font-black text-[10px] border border-cyan-900">ğŸš€ å¯«å…¥ç—…æ­·</button>
                                        </div>
                                    );
                                })}
                            </div>
                        )}
                        {/* å…¶ä»–åˆ†é å…§å®¹é è¨­è¼‰å…¥ Firebase æ•¸æ“š... */}
                        {activeTab === 'monitor' && <div className="text-gray-500 text-center text-xs mt-20">æ•¸æ“šä¸­å¿ƒå³æ™‚åŒæ­¥ä¸­...</div>}
                    </main>
                    <footer className="p-4 text-center border-t border-neutral-900"><p className="text-[9px] text-gray-700 font-black">Tactical Cloud - Reinstalled 2026</p></footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
