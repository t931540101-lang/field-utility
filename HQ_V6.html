<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-SECURITY | HQ æˆ°è¡“çµ‚ç«¯ V6.8</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --cyan: #00f2ff; --warn: #ff4d4f; --bg: #050505; --card: #111; --border: #333; --accent: #27ae60; }
        body { background: var(--bg); color: white; font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
        
        /* é ‚éƒ¨èº«ä»½è³‡è¨Š */
        .user-info { background: #1e293b; color: white; padding: 8px 15px; font-size: 12px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--cyan); }
        .user-info span { cursor: pointer; }

        header { background: #000; padding: 12px; text-align: center; border-bottom: 1px solid var(--border); }
        header h1 { margin: 0; font-size: 18px; font-style: italic; color: var(--cyan); letter-spacing: 2px; }

        nav { display: flex; background: #111; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .tab-btn { flex: 1; padding: 12px 5px; text-align: center; color: #666; font-size: 12px; font-weight: bold; cursor: pointer; }
        .tab-btn.active { color: var(--cyan); border-bottom: 2px solid var(--cyan); background: #1a1a1a; }

        .content { padding: 12px; display: none; }
        .content.active { display: block; }

        .section { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        h2 { font-size: 15px; color: var(--cyan); border-left: 4px solid var(--cyan); padding-left: 8px; margin: 0 0 12px 0; }
        
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .full-width { grid-column: span 2; }
        label { font-size: 11px; color: #aaa; font-weight: bold; display: block; margin-bottom: 2px; }
        
        input, textarea, select { width: 100%; padding: 10px; background: #000; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 14px; box-sizing: border-box; margin-bottom: 8px; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-cyan { background: var(--cyan); color: #000; }
        .btn-red { background: var(--warn); color: #fff; }
        .btn-green { background: var(--accent); color: #fff; }

        /* è¨ªå®¢åˆ—è¡¨å°ˆç”¨æ¨£å¼ */
        .log-item { background: #fff; border-left: 5px solid var(--accent); padding: 12px; margin-bottom: 10px; border-radius: 5px; color: #333; position: relative; }
        .log-header { display: flex; justify-content: space-between; font-weight: bold; color: #2c3e50; margin-bottom: 5px; padding-right: 40px; }
        .del-btn { position: absolute; top: 10px; right: 10px; color: var(--warn); font-size: 11px; cursor: pointer; padding: 2px 5px; border: 1px solid #ffeded; border-radius: 4px; }
        .checkout-btn { margin-top: 8px; background: #fff; color: var(--accent); border: 1px solid var(--accent); padding: 6px; border-radius: 4px; width: 100%; font-weight: bold; font-size: 12px; }

        .scroll-box { max-height: 400px; overflow-y: auto; border: 1px solid #222; background: #000; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #1a1a1a; color: var(--cyan); padding: 8px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #222; color: #ccc; }
    </style>
</head>
<body>

<div class="user-info">
    <span onclick="changeName()">å§“åï¼š<span id="userNameDisplay">æœªè¨­å®š</span> âœ</span>
    <span onclick="changeID()">å·¥è™Ÿï¼š<span id="userIDDisplay">æœªè¨­å®š</span> âœ</span>
</div>

<header>
    <h1>M-SECURITY HQ</h1>
    <small>INTEGRATED TERMINAL V6.8</small>
</header>

<nav>
    <div class="tab-btn active" onclick="switchTab('monitor')">ç›£æ§æ—¥èªŒ</div>
    <div class="tab-btn" onclick="switchTab('visitor')">è¨ªå®¢ç³»çµ±</div>
    <div class="tab-btn" onclick="switchTab('handover')">å‹¤å‹™äº¤æ¥</div>
    <div class="tab-btn" onclick="switchTab('manage')">éƒ¨ç½²ç®¡ç†</div>
</nav>

<div id="monitor" class="content active">
    <h2>ğŸ“¡ æ‰‹æ©ŸæŸ¥è©¢å³æ™‚å‹•æ…‹</h2>
    <div class="scroll-box">
        <table>
            <thead><tr><th>æ™‚é–“</th><th>æŸ¥è©¢å“¡</th><th>å°è±¡</th></tr></thead>
            <tbody id="realtimeLogs"></tbody>
        </table>
    </div>
</div>

<div id="visitor" class="content">
    <div class="section">
        <h2>è¨ªå®¢ç™»è¨˜å…¥å» </h2>
        <div class="form-grid">
            <div class="full-width"><label>è¨ªå®¢å§“å</label><input type="text" id="vName"></div>
            <div><label>ä¾†è¨ªäººæ•¸</label><input type="number" id="vCount" value="1"></div>
            <div><label>é›»è©±</label><input type="tel" id="vPhone"></div>
            <div class="full-width"><label>å…¬å¸è¡Œè™Ÿ</label><input type="text" id="vComp"></div>
            <div class="full-width"><label>å—è¨ªäººå“¡</label><input type="text" id="vTarget"></div>
            <div class="full-width"><label>äº‹ç”±</label><textarea id="vReason" rows="1"></textarea></div>
        </div>
        <button class="btn btn-green" onclick="submitVisitor()">é€å‡ºç™»è¨˜ä¸¦åŒæ­¥é›²ç«¯</button>
    </div>
    <div id="visitorLogList">
        <h3 style="text-align:center; font-size: 13px; color: #666;">å¯¦æ™‚ç™»è¨˜æ¸…å–®</h3>
    </div>
</div>

<div id="handover" class="content">
    <div class="section">
        <button class="btn btn-cyan" onclick="addHandover()">+ æ–°å¢äº¤æ¥äº‹é …</button>
    </div>
    <div id="handoverList"></div>
</div>

<div id="manage" class="content">
    <div class="section">
        <h2>åå–®éƒ¨ç½²</h2>
        <input type="text" id="eID" placeholder="å·¥è™Ÿ">
        <input type="text" id="eName" placeholder="å§“å">
        <input type="text" id="ePlate" placeholder="è»Šç‰Œ">
        <input type="text" id="eReason" placeholder="å–®ä½/å‚™è¨»">
        <div style="display:flex; gap:8px;">
            <button class="btn btn-cyan" onclick="deploy('employee_list')">å­˜ç‚ºå“¡å·¥</button>
            <button class="btn btn-red" onclick="deploy('blacklist_data')">ç™¼å¸ƒè­¦æˆ’</button>
        </div>
    </div>
    <div class="scroll-box">
        <table>
            <thead><tr><th>é¡å‹</th><th>å°è±¡</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="masterTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // --- Firebase é…ç½® ---
    const firebaseConfig = {
        apiKey: "AIzaSyB2_tKKsVT4kdW7PPkJgI9O7S1YdCWor48",
        databaseURL: "https://factor-security-d1965-default-rtdb.firebaseio.com",
        projectId: "factor-security-d1965",
        appId: "1:864846943143:web:4cfa18cd20d2f712225c82"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- èº«åˆ†è¨˜æ†¶é‚è¼¯ ---
    let userName = localStorage.getItem('guardName') || "";
    let userID = localStorage.getItem('guardID') || "";
    function updateUserInfo() {
        document.getElementById('userNameDisplay').innerText = userName || "æœªè¨­å®š";
        document.getElementById('userIDDisplay').innerText = userID || "æœªè¨­å®š";
    }
    function changeName() {
        const n = prompt("è«‹è¼¸å…¥æ‚¨çš„å§“å", userName);
        if(n) { userName = n; localStorage.setItem('guardName', n); updateUserInfo(); }
    }
    function changeID() {
        const id = prompt("è«‹è¼¸å…¥æ‚¨çš„å·¥è™Ÿ", userID);
        if(id) { userID = id; localStorage.setItem('guardID', id); updateUserInfo(); }
    }
    window.onload = updateUserInfo;

    // --- åˆ†é åˆ‡æ› ---
    function switchTab(id) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // --- 1. ç›£æ§æ—¥èªŒ ---
    db.ref('search_logs').limitToLast(15).on('value', snap => {
        const tbody = document.getElementById('realtimeLogs');
        tbody.innerHTML = '';
        snap.forEach(c => {
            const l = c.val();
            tbody.innerHTML = `<tr><td>${l.time?l.time.split(' ')[1]:'--'}</td><td style="color:var(--cyan)">${l.user}</td><td>${l.query}</td></tr>` + tbody.innerHTML;
        });
    });

    // --- 2. å°ˆæ¥­è¨ªå®¢ç³»çµ±é‚è¼¯ ---
    function submitVisitor() {
        if(!userName) return alert("è«‹å…ˆè¨­å®šä¸Šæ–¹ã€Œå§“åã€ï¼");
        const val = document.getElementById('vName').value;
        if(!val) return alert("è«‹è¼¸å…¥è¨ªå®¢å§“å");
        
        const now = new Date();
        const timeIn = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        
        const logData = {
            date: now.toISOString().split('T')[0],
            name: val,
            count: document.getElementById('vCount').value,
            phone: document.getElementById('vPhone').value,
            company: document.getElementById('vComp').value,
            target: document.getElementById('vTarget').value,
            timeIn: timeIn,
            leaveTime: "",
            recorder: userName,
            reason: document.getElementById('vReason').value,
            timestamp: Date.now()
        };

        db.ref('visitor_logs').push(logData).then(() => {
            alert("ç™»è¨˜æˆåŠŸï¼");
            document.querySelectorAll('#visitor input, #visitor textarea').forEach(i => { if(i.id !== 'vCount') i.value = ""; });
        });
    }

    db.ref('visitor_logs').limitToLast(10).on('value', (snapshot) => {
        const listDiv = document.getElementById('visitorLogList');
        listDiv.innerHTML = '<h3 style="text-align:center; font-size: 13px; color: #666;">å¯¦æ™‚ç™»è¨˜æ¸…å–®</h3>';
        const data = snapshot.val();
        if (data) {
            Object.keys(data).reverse().forEach(key => {
                const item = data[key];
                const isOut = item.leaveTime !== "";
                listDiv.innerHTML += `
                    <div class="log-item" style="${isOut ? 'opacity: 0.6; border-left-color: #ccc;' : ''}">
                        <span class="del-btn" onclick="deleteVisitor('${key}')">åˆªé™¤</span>
                        <div class="log-header">
                            <span>${item.name} (${item.count}äºº)</span>
                            <span style="color: ${isOut ? '#999' : '#27ae60'}">${isOut ? 'å·²å‡ºå» ' : 'åœ¨å ´ä¸­'}</span>
                        </div>
                        <div style="font-size:12px; color:#555; line-height: 1.4;">
                            å…¬å¸ï¼š${item.company}<br>
                            æ‹œè¨ªï¼š${item.target} | å…¥å» ï¼š${item.timeIn}<br>
                            ${isOut ? '<b>å‡ºå» ï¼š' + item.leaveTime + '</b>' : ''}
                        </div>
                        ${!isOut ? `<button class="checkout-btn" onclick="checkoutVisitor('${key}')">ç°½é€€é›¢é–‹</button>` : ''}
                    </div>`;
            });
        }
    });
    function checkoutVisitor(key) {
        const leaveTime = prompt("ç¢ºèªå‡ºå» æ™‚é–“ï¼š", new Date().getHours().toString().padStart(2, '0') + ":" + new Date().getMinutes().toString().padStart(2, '0'));
        if(leaveTime) db.ref('visitor_logs/' + key).update({ leaveTime: leaveTime });
    }
    function deleteVisitor(key) { if(confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) db.ref('visitor_logs/' + key).remove(); }

    // --- 3. å‹¤å‹™äº¤æ¥ ---
    function addHandover() {
        const note = prompt("äº¤æ¥äº‹é …ï¼š");
        if(note) db.ref('reactLogs').push({ note, time: new Date().toLocaleString('zh-TW',{hour12:false}), timestamp: Date.now(), confirmedBy: null });
    }
    db.ref('reactLogs').limitToLast(10).on('value', snap => {
        const box = document.getElementById('handoverList'); box.innerHTML = '';
        snap.forEach(c => {
            const h = c.val();
            box.innerHTML = `
                <div class="section" style="border-left:5px solid ${h.confirmedBy?'#10b981':var(--cyan)}; opacity:${h.confirmedBy?0.6:1}">
                    <div style="font-size:10px; color:#666;">${h.time}</div>
                    <div style="font-weight:bold; font-size:16px; margin:5px 0;">${h.note}</div>
                    ${!h.confirmedBy?`<button class="btn btn-cyan" style="padding:5px; font-size:12px;" onclick="confH('${c.key}')">ç°½ç½²ç¢ºèª</button>`:`<small style="color:#10b981">âœ“ å·²é–±: ${h.confirmedBy}</small>`}
                    <span style="float:right; cursor:pointer; color:#444;" onclick="db.ref('reactLogs/${c.key}').remove()">âœ•</span>
                </div>` + box.innerHTML;
        });
    });
    function confH(key) { const n = prompt("å§“å", "å°é»‘å“¥"); if(n) db.ref('reactLogs/'+key).update({confirmedBy:n}); }

    // --- 4. éƒ¨ç½²ç®¡ç† ---
    function deploy(path) {
        const name = document.getElementById('eName').value;
        if(!name) return;
        db.ref(path + '/' + (document.getElementById('eID').value || Date.now())).set({
            name, id: document.getElementById('eID').value, plate: document.getElementById('ePlate').value.toUpperCase(), reason: document.getElementById('eReason').value
        }).then(() => { alert("éƒ¨ç½²æˆåŠŸ"); });
    }
    function updateM() {
        const tb = document.getElementById('masterTableBody'); tb.innerHTML = '';
        const f = (p, l, c) => {
            db.ref(p).once('value', s => { s.forEach(child => {
                const i = child.val();
                tb.innerHTML += `<tr><td><span style="color:${c}">${l}</span></td><td>${i.name}</td><td>${i.reason||i.id||'--'}</td><td><button style="color:red;background:none;border:none;" onclick="db.ref('${p}/${child.key}').remove()">[åˆª]</button></td></tr>`;
            }); });
        };
        f('employee_list','å“¡å·¥','var(--cyan)'); f('blacklist_data','è­¦æˆ’','var(--warn)');
    }
    db.ref('employee_list').on('value', updateM); db.ref('blacklist_data').on('value', updateM);
</script>
</body>
</html>
