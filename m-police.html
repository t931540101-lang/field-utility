<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-SECURITY | 戰術終端 V7.6</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --mp-blue: #3273b5; --mp-grad: linear-gradient(to bottom, #74b9ff, #3273b5); --btn-blue: linear-gradient(to bottom, #74b9ff, #0984e3); --alert-red: #ff0000; }
        body { margin: 0; background: #b0bec5; font-family: "Microsoft JhengHei", sans-serif; overflow: hidden; height: 100vh; width: 100vw; }
        #login-page { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; height: 100vh; background: #e3f2fd; padding-top: 15%; }
        .login-box { width: 85%; max-width: 320px; background: white; border: 1px solid #90caf9; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #main-terminal { display: none; height: 100vh; flex-direction: column; }
        .alert-bar { background: #000; color: var(--alert-red); padding: 5px; text-align: center; font-size: 11px; font-weight: bold; }
        .header-banner { background: var(--mp-grad); padding: 12px 0; text-align: center; color: white; }
        .tabs { display: flex; background: #546e7a; }
        .tab { flex: 1; text-align: center; padding: 10px 0; color: white; font-size: 13px; border-right: 1px solid #455a64; }
        .tab.active { background: var(--mp-blue); }
        .content { flex: 1; padding: 10px; background: #cfd8dc; overflow-y: auto; }
        .search-card { background: #fff; border: 1px solid #999; padding: 12px; border-radius: 4px; }
        input, select { width: 100%; height: 42px; border: 1px solid #ccc; margin-bottom: 8px; padding: 0 10px; font-size: 16px; box-sizing: border-box; border-radius: 4px; }
        .btn-mp { width: 100%; height: 46px; color: white; font-weight: bold; font-size: 16px; background: var(--btn-blue); border: none; border-radius: 4px; }
        .res-box { margin-top: 10px; padding: 15px; border-radius: 4px; display: none; text-align: center; border: 2px solid transparent; }
        .res-ok { background: #e8f5e9; border-color: #2e7d32; color: #1b5e20; }
        .res-warn { background: #ffebee; border-color: #c62828; color: #b71c1c; animation: flash 0.6s infinite; }
        @keyframes flash { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .info-label { font-size: 12px; color: #666; margin-top: 5px; }
        .info-value { font-size: 18px; color: #000; font-weight: bold; }
    </style>
</head>
<body>

    <div id="login-page">
        <div style="color:#0d47a1; font-weight:bold; margin-bottom:20px;">M-Police 整合查詢系統</div>
        <div class="login-box">
            <input type="password" id="loginCode" placeholder="登錄碼">
            <input type="text" id="userName" placeholder="帳號">
            <select id="dutyType"><option>門崗勤務</option><option>巡邏勤務</option></select>
            <button class="btn-mp" onclick="doLogin()">登入系統</button>
        </div>
    </div>

    <div id="main-terminal">
        <div class="alert-bar">[連線正常] 雲端數據即時同步中</div>
        <div class="header-banner"><h1>M-Security 整合查詢</h1></div>
        <div class="content">
            <div class="search-card">
                <input type="text" id="qInput" placeholder="輸入 姓名、工號 或 車牌">
                <button class="btn-mp" onclick="qSearch()">立即查詢</button>
                <button class="btn-mp" style="background:#607d8b; margin-top:8px;" onclick="location.reload()">清除結果</button>
            </div>
            <div id="res" class="res-box"><div id="res-info"></div></div>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyB2_tKKsVT4kdW7PPkJgI9O7S1YdCWor48",
        databaseURL: "https://factor-security-d1965-default-rtdb.firebaseio.com",
        projectId: "factor-security-d1965",
        appId: "1:864846943143:web:4cfa18cd20d2f712225c82"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function doLogin() {
        if(!document.getElementById('loginCode').value) return alert("請輸入登錄碼");
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('main-terminal').style.display = 'flex';
    }

    async function qSearch() {
        const val = document.getElementById('qInput').value.trim().toUpperCase();
        if(!val) return;
        
        const resBox = document.getElementById('res');
        const resInfo = document.getElementById('res-info');
        resBox.style.display = 'block';
        resBox.className = "res-box";
        resInfo.innerHTML = "比對數據庫中...";

        // 寫入日誌
        db.ref('search_logs').push({
            user: document.getElementById('userName').value || "未知",
            query: val,
            duty: document.getElementById('dutyType').value,
            time: new Date().toLocaleString('zh-TW', {hour12: false})
        });

        // --- 強大查詢邏輯：同時掃描員工與黑名單 ---
        try {
            const [snapEmp, snapBlack] = await Promise.all([
                db.ref('employee_list').once('value'),
                db.ref('blacklist_data').once('value')
            ]);

            const emps = snapEmp.val() || {};
            const blacks = snapBlack.val() || {};
            let found = null;
            let isBlack = false;

            // 1. 優先找黑名單 (不論是名字、工號還是車牌)
            for(let key in blacks) {
                let b = blacks[key];
                if(b.name === val || b.id === val || b.plate === val) {
                    found = b; isBlack = true; break;
                }
            }

            // 2. 如果黑名單沒找到，找員工
            if(!found) {
                for(let key in emps) {
                    let e = emps[key];
                    if(e.name === val || e.id === val || e.plate === val || key === val) {
                        found = e; break;
                    }
                }
            }

            // 3. 顯示結果
            if(found) {
                resBox.className = "res-box " + (isBlack ? "res-warn" : "res-ok");
                resInfo.innerHTML = `
                    <div style="font-size:16px; font-weight:bold;">${isBlack ? '⚠️ 警戒對象 (黑名單)' : '✅ 內部人員'}</div>
                    <div class="info-label">姓名</div><div class="info-value">${found.name}</div>
                    <div class="info-label">標記/單位</div><div class="info-value">${found.reason || found.id || '---'}</div>
                `;
            } else {
                resBox.style.background = "#eee";
                resInfo.innerHTML = "查無此資料";
            }
        } catch(e) {
            resInfo.innerHTML = "連線錯誤";
        }
    }
</script>
</body>
</html>
