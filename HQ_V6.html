<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-SECURITY | HQ æ——è‰¦çµ‚ç«¯ V6.7</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        :root { --main-cyan: #00f2ff; --warn-red: #ff4d4f; --bg-dark: #050505; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-dark); color: white; margin: 0; }
        
        /* K9 å°ˆç”¨æ¨£å¼ */
        .medical-card { background: #111; border: 1px solid #333; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,242,255,0.05); }
        .stamp-red { border: 2px solid #ef4444; color: #ef4444; transform: rotate(-5deg); font-weight: 900; padding: 2px 8px; border-radius: 4px; display: inline-block; font-size: 10px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* åŸºç¤æˆ°è¡“æ¨£å¼ */
        .duty-card { background: #1a1a1a; border-left: 6px solid var(--main-cyan); }
        .confirmed-card { background: #064e3b; border-left-color: #10b981; opacity: 0.8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyB2_tKKsVT4kdW7PPkJgI9O7S1YdCWor48",
            authDomain: "factor-security-d1965.firebaseapp.com",
            databaseURL: "https://factor-security-d1965-default-rtdb.firebaseio.com",
            projectId: "factor-security-d1965",
            storageBucket: "factor-security-d1965.firebasestorage.app",
            messagingSenderId: "864846943143",
            appId: "1:864846943143:web:4cfa18cd20d2f712225c82"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function App() {
            const [activeTab, setActiveTab] = useState('monitor');
            const [logs, setLogs] = useState([]); // äº¤æ¥ç´€éŒ„
            const [visitors, setVisitors] = useState([]); // è¨ªå®¢ç´€éŒ„
            const [masterData, setMasterData] = useState([]); // å“¡å·¥/é»‘åå–®
            const [k9Logs, setK9Logs] = useState({}); // K9 ç—…æ­·ç´€éŒ„
            
            // K9 åå†Š
            const [k9List] = useState([
                { id: 'å¸ƒä¸', name: 'å¼µå¸ƒä¸', weight: '43.5' },
                { id: 'å°ç™½', name: 'è”¡å°ç™½', weight: '23.5' },
                { id: 'å°èŠ±', name: 'è”¡å°èŠ±', weight: '23.3' },
                { id: 'ä¾†é †', name: 'ä¾†é †', weight: '25.2' },
                { id: 'ç“œç“œ', name: 'å“ˆèœœç“œ', weight: '24.5' },
                { id: 'è²´è²´', name: 'è”¡é ­è²´', weight: '25.1' },
                { id: 'è”¡å“º', name: 'è”¡å“º', weight: '23.3' },
                { id: 'æœ‰éŒ¢', name: 'æœ‰éŒ¢', weight: '25.6' }
            ]);

            useEffect(() => {
                // ç›£è½äº¤æ¥ç´€éŒ„
                db.ref('reactLogs').on('value', snap => {
                    const data = snap.val();
                    if (data) setLogs(Object.keys(data).map(k => ({ id: k, ...data[k] })).sort((a,b) => b.timestamp - a.timestamp));
                });

                // ç›£è½ K9 ç´€éŒ„
                db.ref('k9Logs').on('value', snap => {
                    setK9Logs(snap.val() || {});
                });

                // ç›£è½è¨ªå®¢ç´€éŒ„
                db.ref('visitor_logs').on('value', snap => {
                    const data = snap.val();
                    if (data) setVisitors(Object.keys(data).map(k => ({ id: k, ...data[k] })).reverse());
                });

                // ç›£è½åå–®
                const refreshMaster = async () => {
                    const [emp, black, vip] = await Promise.all([
                        db.ref('employee_list').once('value'),
                        db.ref('blacklist_data').once('value'),
                        db.ref('vip_vehicles').once('value')
                    ]);
                    let combined = [];
                    if(emp.val()) Object.keys(emp.val()).forEach(k => combined.push({type:'EMP', id:k, ...emp.val()[k]}));
                    if(black.val()) Object.keys(black.val()).forEach(k => combined.push({type:'BLACK', id:k, ...black.val()[k]}));
                    if(vip.val()) Object.keys(vip.val()).forEach(k => combined.push({type:'VIP', id:k, ...vip.val()[k]}));
                    setMasterData(combined);
                };
                db.ref('employee_list').on('value', refreshMaster);
                
                return () => db.ref('reactLogs').off();
            }, []);

            // K9 åŠŸèƒ½ï¼šå¯«å…¥ç—…æ­·
            const addK9Log = (dogId, dogName) => {
                const note = prompt(`ç‚º ${dogName} è¼¸å…¥ä»Šæ—¥ç´€éŒ„ï¼š`);
                if (!note) return;
                const now = new Date();
                const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${(now.getMinutes()<10?'0':'')+now.getMinutes()}`;
                db.ref(`k9Logs/${dogId}`).push({
                    time: timeStr, note, timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            };

            // é é¢åˆ‡æ›
            const TabBtn = ({id, label}) => (
                <button onClick={() => setActiveTab(id)} 
                    className={`flex-1 py-3 text-xs font-black uppercase tracking-tighter transition-all ${activeTab === id ? 'text-cyan-400 border-b-2 border-cyan-400 bg-neutral-800' : 'text-gray-500'}`}>
                    {label}
                </button>
            );

            return (
                <div className="min-h-screen flex flex-col bg-black">
                    <header className="bg-black border-b-2 border-cyan-400 p-4 flex justify-between items-center">
                        <div>
                            <h1 className="text-xl font-black italic tracking-widest text-cyan-400">M-SECURITY HQ</h1>
                            <p className="text-[9px] text-gray-500 font-bold uppercase">Tactical Operations Hub V6.7</p>
                        </div>
                        <div className="stamp-red">ç™¼å°„æˆåŠŸ</div>
                    </header>

                    <nav className="flex bg-neutral-900 border-b border-neutral-800 sticky top-0 z-50">
                        <TabBtn id="monitor" label="ç›£æ§" />
                        <TabBtn id="visitor" label="è¨ªå®¢" />
                        <TabBtn id="handover" label="äº¤æ¥" />
                        <TabBtn id="k9" label="K9æˆ°çŠ¬" />
                        <TabBtn id="manage" label="ç®¡ç†" />
                    </nav>

                    <main className="p-4 flex-1 no-scrollbar overflow-y-auto">
                        {/* K9 æˆ°çŠ¬åˆ†é  */}
                        {activeTab === 'k9' && (
                            <div className="grid gap-6">
                                {k9List.map(dog => {
                                    const logs = k9Logs[dog.id] ? Object.keys(k9Logs[dog.id]).map(key => ({
                                        key, ...k9Logs[dog.id][key]
                                    })).sort((a,b) => b.timestamp - a.timestamp) : [];
                                    
                                    return (
                                        <div key={dog.id} className="medical-card p-4">
                                            <div className="flex justify-between items-end mb-3 border-b border-neutral-800 pb-2">
                                                <span className="text-xl font-black text-cyan-400">{dog.name}</span>
                                                <span className="text-[10px] font-bold text-gray-500 italic">é«”é‡: {dog.weight} KG</span>
                                            </div>
                                            <div className="space-y-3 mb-4">
                                                {logs.slice(0, 2).map(log => (
                                                    <div key={log.key} className="bg-neutral-800/50 p-3 rounded border-l-2 border-cyan-900 relative">
                                                        <div className="text-[9px] font-bold text-gray-600 mb-1">{log.time}</div>
                                                        <p className="text-sm font-bold text-gray-300">{log.note}</p>
                                                        <button onClick={() => db.ref(`k9Logs/${dog.id}/${log.key}`).remove()} className="absolute top-2 right-2 text-gray-700 hover:text-red-500 text-[9px]">åˆªé™¤</button>
                                                    </div>
                                                ))}
                                                {logs.length === 0 && <p className="text-gray-700 text-xs italic">å°šç„¡é†«ç™‚ç´€éŒ„</p>}
                                            </div>
                                            <button onClick={() => addK9Log(dog.id, dog.name)} 
                                                className="w-full bg-neutral-800 hover:bg-cyan-900 text-cyan-400 py-2 rounded font-black text-xs border border-cyan-900 transition-all">
                                                ğŸš€ å¯«å…¥è‡¨åºŠç´€éŒ„
                                            </button>
                                        </div>
                                    );
                                })}
                            </div>
                        )}

                        {/* äº¤æ¥åˆ†é  (ç¶­æŒåŸæ¨£) */}
                        {activeTab === 'handover' && (
                            <div className="space-y-4 max-w-xl mx-auto">
                                <button onClick={() => {
                                    const note = prompt("äº¤æ¥äº‹é …ï¼š");
                                    if(note) db.ref('reactLogs').push({ time: new Date().toLocaleString(), note, timestamp: Date.now() });
                                }} className="w-full bg-cyan-500 text-black font-black py-3 rounded-lg">+ æ–°å¢äº¤æ¥</button>
                                {logs.map(log => (
                                    <div key={log.id} className={`p-4 rounded-lg duty-card ${log.confirmedBy ? 'confirmed-card' : ''}`}>
                                        <div className="text-[10px] text-gray-500 mb-1">{log.time}</div>
                                        <p className="font-bold">{log.note}</p>
                                        {!log.confirmedBy && <button onClick={() => db.ref(`reactLogs/${log.id}`).update({confirmedBy:'å°é»‘å“¥'})} className="mt-2 text-xs text-cyan-400">é»æ“Šç¢ºèª</button>}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* ç›£æ§ã€è¨ªå®¢ã€ç®¡ç†åˆ†é é‚è¼¯åŒ V6.6... (ç‚ºç¸®æ¸›é•·åº¦ç•¥éé‡è¤‡ UIï¼ŒåŠŸèƒ½çš†ä¿ç•™) */}
                        {activeTab === 'monitor' && <div className="text-gray-500 text-center text-xs mt-20">ç›£æ§æ—¥èªŒå³æ™‚é€£ç·šä¸­...</div>}
                    </main>

                    <footer className="p-4 text-center border-t border-neutral-900 bg-black">
                        <p className="text-[9px] text-gray-700 tracking-widest uppercase font-black">Tactical Cloud - Internal Use Only</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
