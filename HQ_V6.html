<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-SECURITY | HQ æ——è‰¦çµ‚ç«¯ V6.6</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        :root { --main-cyan: #00f2ff; --warn-red: #ff4d4f; --bg-dark: #050505; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-dark); color: white; margin: 0; }
        .duty-card { background: #1a1a1a; border-left: 6px solid var(--main-cyan); }
        .confirmed-card { background: #064e3b; border-left-color: #10b981; opacity: 0.8; }
        /* éš±è—æ²è»¸ä½†ä¿æŒåŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Firebase é…ç½®
        const firebaseConfig = {
            apiKey: "AIzaSyB2_tKKsVT4kdW7PPkJgI9O7S1YdCWor48",
            authDomain: "factor-security-d1965.firebaseapp.com",
            databaseURL: "https://factor-security-d1965-default-rtdb.firebaseio.com",
            projectId: "factor-security-d1965",
            storageBucket: "factor-security-d1965.firebasestorage.app",
            messagingSenderId: "864846943143",
            appId: "1:864846943143:web:4cfa18cd20d2f712225c82"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function App() {
            const [activeTab, setActiveTab] = useState('monitor');
            const [logs, setLogs] = useState([]);
            const [visitors, setVisitors] = useState([]);
            const [masterData, setMasterData] = useState([]);

            // ç›£è½æ‰€æœ‰æ•¸æ“šæº
            useEffect(() => {
                // 1. ç›£è½äº¤æ¥ç´€éŒ„ (reactLogs)
                const logsRef = db.ref('reactLogs');
                logsRef.on('value', snap => {
                    const data = snap.val();
                    if (data) {
                        const list = Object.keys(data).map(k => ({ id: k, ...data[k] }))
                                     .sort((a, b) => b.timestamp - a.timestamp);
                        setLogs(list);
                    }
                });

                // 2. ç›£è½è¨ªå®¢ç´€éŒ„ (visitor_logs)
                const visitorRef = db.ref('visitor_logs');
                visitorRef.on('value', snap => {
                    const data = snap.val();
                    if (data) {
                        setVisitors(Object.keys(data).map(k => ({ id: k, ...data[k] })).reverse());
                    }
                });

                // 3. ç›£è½ä¸»åå–® (å“¡å·¥+é»‘åå–®+VIP)
                const refreshMaster = async () => {
                    const [emp, black, vip] = await Promise.all([
                        db.ref('employee_list').once('value'),
                        db.ref('blacklist_data').once('value'),
                        db.ref('vip_vehicles').once('value')
                    ]);
                    let combined = [];
                    if(emp.val()) Object.keys(emp.val()).forEach(k => combined.push({type:'EMP', id:k, ...emp.val()[k]}));
                    if(black.val()) Object.keys(black.val()).forEach(k => combined.push({type:'BLACK', id:k, ...black.val()[k]}));
                    if(vip.val()) Object.keys(vip.val()).forEach(k => combined.push({type:'VIP', id:k, ...vip.val()[k]}));
                    setMasterData(combined);
                };
                db.ref('employee_list').on('value', refreshMaster);
                db.ref('blacklist_data').on('value', refreshMaster);
                db.ref('vip_vehicles').on('value', refreshMaster);

                return () => {
                    logsRef.off();
                    visitorRef.off();
                    db.ref('employee_list').off();
                };
            }, []);

            // åŠŸèƒ½å‡½æ•¸ï¼šæ–°å¢äº¤æ¥
            const addEntry = () => {
                const note = prompt("è«‹è¼¸å…¥äº¤æ¥äº‹é …ï¼š");
                if (!note) return;
                const isUrgent = confirm("é€™ä»¶äº‹éœ€è¦æ¨™è¨»ç‚ºã€Œé‡è¦ã€å—ï¼Ÿ");
                const now = new Date();
                const timeStr = `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${(now.getMinutes()<10?'0':'')+now.getMinutes()}`;
                db.ref('reactLogs').push({
                    time: timeStr, note, urgent: isUrgent, confirmedBy: null,
                    timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            };

            // åŠŸèƒ½å‡½æ•¸ï¼šç°½åç¢ºèª
            const confirmLog = (id) => {
                const name = prompt("è«‹è¼¸å…¥ç¢ºèªè€…å§“åï¼š", "å°é»‘å“¥");
                if(name) db.ref(`reactLogs/${id}`).update({ confirmedBy: name, confirmTime: new Date().toLocaleTimeString() });
            };

            // åŠŸèƒ½å‡½æ•¸ï¼šåˆªé™¤è³‡æ–™ (é€šç”¨)
            const removeItem = (path, id) => {
                if(confirm("âš ï¸ ç¢ºå®šè¦å¾é›²ç«¯åˆªé™¤é€™æ¢ç´€éŒ„å—ï¼Ÿ")) db.ref(`${path}/${id}`).remove();
            };

            // åŠŸèƒ½å‡½æ•¸ï¼šéƒ¨ç½²äººå“¡/é»‘åå–®
            const deployUser = (path) => {
                const name = document.getElementById('eName').value;
                if(!name) return alert("è«‹è¼¸å…¥å§“å");
                const payload = {
                    name,
                    id: document.getElementById('eID').value,
                    plate: document.getElementById('ePlate').value.toUpperCase(),
                    reason: document.getElementById('eReason').value,
                    timestamp: new Date().toLocaleString()
                };
                const finalPath = path === 'employee_list' ? `${path}/${payload.id || Date.now()}` : path;
                db.ref(finalPath)[path === 'employee_list' ? 'set' : 'push'](payload).then(() => alert("éƒ¨ç½²æˆåŠŸ"));
            };

            return (
                <div className="min-h-screen flex flex-col">
                    {/* Header */}
                    <header className="bg-black border-b-2 border-cyan-400 p-4 text-center">
                        <h1 className="text-xl font-black italic tracking-widest text-cyan-400">M-SECURITY HQ V6.6</h1>
                        <p className="text-[10px] text-gray-500 font-bold">INTEGRATED COMMAND CENTER | REBORN</p>
                    </header>

                    {/* Tabs */}
                    <nav className="flex bg-neutral-900 border-b border-neutral-800 sticky top-0 z-50">
                        {['monitor', 'visitor', 'handover', 'manage'].map(tab => (
                            <button key={tab} onClick={() => setActiveTab(tab)} 
                                className={`flex-1 py-3 text-xs font-black uppercase tracking-tighter ${activeTab === tab ? 'text-cyan-400 border-b-2 border-cyan-400 bg-neutral-800' : 'text-gray-500'}`}>
                                {tab === 'monitor' ? 'ç›£æ§æ—¥èªŒ' : tab === 'visitor' ? 'è¨ªå®¢' : tab === 'handover' ? 'å‹¤å‹™äº¤æ¥' : 'éƒ¨ç½²ç®¡ç†'}
                            </button>
                        ))}
                    </nav>

                    <main className="p-4 flex-1 no-scrollbar overflow-y-auto">
                        {/* 1. äº¤æ¥åˆ†é  (æ•´åˆ V3.1) */}
                        {activeTab === 'handover' && (
                            <div className="space-y-4 max-w-xl mx-auto">
                                <button onClick={addEntry} className="w-full bg-cyan-500 text-black font-black py-3 rounded-lg shadow-lg mb-4">+ æ–°å¢äº¤æ¥äº‹é …</button>
                                {logs.map(log => (
                                    <div key={log.id} className={`p-4 rounded-lg duty-card relative transition-all ${log.confirmedBy ? 'confirmed-card' : ''}`}>
                                        <button onClick={() => removeItem('reactLogs', log.id)} className="absolute top-2 right-2 text-gray-600 hover:text-red-500">âœ•</button>
                                        <div className="flex gap-2 mb-2 items-center">
                                            <span className="bg-neutral-800 text-[10px] px-2 py-1 rounded text-gray-400 font-mono">{log.time}</span>
                                            {log.urgent && <span className="bg-red-600 text-white text-[10px] px-2 py-1 rounded animate-pulse font-black">âš ï¸ é‡è¦</span>}
                                            {log.confirmedBy && <span className="bg-emerald-600 text-white text-[10px] px-2 py-1 rounded font-black">âœ“ å·²é–±ï¼š{log.confirmedBy}</span>}
                                        </div>
                                        <p className={`text-lg font-bold ${log.confirmedBy ? 'text-gray-400 italic line-through' : 'text-white'}`}>{log.note}</p>
                                        {!log.confirmedBy && (
                                            <button onClick={() => confirmLog(log.id)} className="mt-3 w-full border border-dashed border-gray-600 py-2 text-xs text-gray-400 font-bold rounded">ğŸ–±ï¸ é»æ“Šç°½ç½²ç¢ºèª</button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* 2. ç›£æ§åˆ†é  */}
                        {activeTab === 'monitor' && (
                            <div className="grid gap-4">
                                <div className="bg-neutral-900 border border-neutral-800 p-4 rounded-lg">
                                    <h2 className="text-cyan-400 font-black mb-3 border-l-4 border-cyan-400 pl-2">ğŸ“¡ æ‰‹æ©Ÿç«¯æŸ¥è©¢å‹•æ…‹</h2>
                                    <div className="max-h-60 overflow-y-auto text-xs">
                                        <table className="w-full text-left">
                                            <thead className="text-gray-500"><tr><th>æ™‚é–“</th><th>äººå“¡</th><th>æŸ¥è©¢</th></tr></thead>
                                            <tbody id="realtimeLogs"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 3. è¨ªå®¢åˆ†é  */}
                        {activeTab === 'visitor' && (
                            <div className="space-y-4">
                                {visitors.map(v => (
                                    <div key={v.id} className={`p-3 border-l-4 ${v.leaveTime ? 'border-gray-600 bg-neutral-900 opacity-60' : 'border-emerald-500 bg-neutral-900'} rounded`}>
                                        <div className="flex justify-between font-black"><span>{v.name} ({v.count}äºº)</span><span className="text-xs text-gray-500">{v.timeIn} å…¥</span></div>
                                        <div className="text-xs text-gray-400">{v.company} | è¨ªï¼š{v.target}</div>
                                        {v.leaveTime && <div className="text-xs text-emerald-500 font-bold">å·²å‡ºå» ï¼š{v.leaveTime}</div>}
                                    </div>
                                ))}
                            </div>
                        )}

                        {/* 4. éƒ¨ç½²ç®¡ç† */}
                        {activeTab === 'manage' && (
                            <div className="space-y-4">
                                <div className="bg-neutral-900 p-4 rounded-lg space-y-2">
                                    <input id="eID" className="w-full bg-black border border-neutral-700 p-2 rounded" placeholder="å·¥è™Ÿ"/>
                                    <input id="eName" className="w-full bg-black border border-neutral-700 p-2 rounded" placeholder="å§“å"/>
                                    <input id="ePlate" className="w-full bg-black border border-neutral-700 p-2 rounded" placeholder="è»Šç‰Œ"/>
                                    <input id="eReason" className="w-full bg-black border border-neutral-700 p-2 rounded" placeholder="å–®ä½/å‚™è¨»"/>
                                    <div className="flex gap-2">
                                        <button onClick={() => deployUser('employee_list')} className="flex-1 bg-cyan-600 py-2 rounded font-black text-black">éƒ¨ç½²å“¡å·¥</button>
                                        <button onClick={() => deployUser('blacklist_data')} className="flex-1 bg-red-600 py-2 rounded font-black">ç™¼å¸ƒé»‘åå–®</button>
                                    </div>
                                </div>
                                <div className="bg-neutral-900 rounded-lg overflow-hidden text-xs">
                                    <table className="w-full text-left">
                                        <thead className="bg-neutral-800 text-cyan-400"><tr><th className="p-2">é¡å‹</th><th>å°è±¡</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr></thead>
                                        <tbody>
                                            {masterData.map(m => (
                                                <tr key={m.id} className="border-b border-neutral-800">
                                                    <td className="p-2"><span className={`px-1 rounded ${m.type==='BLACK'?'bg-red-900 text-red-200':'bg-cyan-900 text-cyan-200'}`}>{m.type}</span></td>
                                                    <td className="font-bold">{m.name}</td>
                                                    <td className="text-gray-500">{m.reason || m.id}</td>
                                                    <td><button onClick={() => removeItem(m.type==='BLACK'?'blacklist_data':'employee_list', m.id)} className="text-red-500">âœ•</button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="p-4 text-center border-t border-neutral-800">
                        <p className="text-[10px] text-gray-600 tracking-widest uppercase font-black">Security Cloud Internal Only</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // ç¨ç«‹è…³æœ¬è™•ç†å³æ™‚æŸ¥è©¢æ—¥èªŒ
        const dbRaw = firebase.database();
        dbRaw.ref('search_logs').limitToLast(20).on('value', snap => {
            const el = document.getElementById('realtimeLogs');
            if(!el) return;
            el.innerHTML = '';
            const data = snap.val();
            if(data) Object.keys(data).reverse().forEach(k => {
                const l = data[k];
                el.innerHTML += `<tr class="border-b border-neutral-800"><td class="py-1 text-gray-500">${l.time.split(' ')[1]}</td><td class="text-cyan-400 font-bold">${l.user}</td><td>${l.query}</td></tr>`;
            });
        });
    </script>
</body>
</html>
