<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-SECURITY | HQ 旗艦終端 V6.7 (強化連線版)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        :root { --main-cyan: #00f2ff; --bg-dark: #050505; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: var(--bg-dark); color: white; margin: 0; }
        .duty-card { background: #1a1a1a; border-left: 6px solid var(--main-cyan); }
        .confirmed-card { background: #064e3b; border-left-color: #10b981; }
        .stamp-red { border: 2px solid #ef4444; color: #ef4444; transform: rotate(-5deg); font-weight: 900; padding: 2px 8px; border-radius: 4px; display: inline-block; font-size: 10px; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        const firebaseConfig = {
            apiKey: "AIzaSyB2_tKKsVT4kdW7PPkJgI9O7S1YdCWor48",
            authDomain: "factor-security-d1965.firebaseapp.com",
            databaseURL: "https://factor-security-d1965-default-rtdb.firebaseio.com",
            projectId: "factor-security-d1965",
            storageBucket: "factor-security-d1965.firebasestorage.app",
            messagingSenderId: "864846943143",
            appId: "1:864846943143:web:4cfa18cd20d2f712225c82"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function App() {
            const [activeTab, setActiveTab] = useState('handover');
            const [logs, setLogs] = useState([]);
            const [k9Logs, setK9Logs] = useState({});
            const [visitors, setVisitors] = useState([]);
            const [masterData, setMasterData] = useState([]);
            const [isConnected, setIsConnected] = useState(false);

            useEffect(() => {
                // 監控連線狀態
                const connectedRef = db.ref(".info/connected");
                connectedRef.on("value", (snap) => {
                    setIsConnected(snap.val() === true);
                });

                // 數據監聽 (交接簿)
                db.ref('reactLogs').on('value', snap => {
                    const data = snap.val();
                    if (data) setLogs(Object.keys(data).map(k => ({ id: k, ...data[k] })).sort((a,b) => b.timestamp - a.timestamp));
                });

                // 數據監聽 (K9)
                db.ref('k9Logs').on('value', snap => { setK9Logs(snap.val() || {}); });

                // 數據監聽 (訪客)
                db.ref('visitor_logs').on('value', snap => {
                    const data = snap.val();
                    if (data) setVisitors(Object.keys(data).map(k => ({ id: k, ...data[k] })).reverse());
                });

                return () => db.ref(".info/connected").off();
            }, []);

            const TabBtn = ({id, label}) => (
                <button onClick={() => setActiveTab(id)} 
                    className={`flex-1 py-3 text-xs font-black uppercase transition-all ${activeTab === id ? 'text-cyan-400 border-b-2 border-cyan-400 bg-neutral-800' : 'text-gray-500'}`}>
                    {label}
                </button>
            );

            return (
                <div className="min-h-screen flex flex-col bg-black">
                    <header className="bg-black border-b-2 border-cyan-400 p-4 flex justify-between items-center">
                        <div>
                            <h1 className="text-xl font-black italic tracking-widest text-cyan-400">M-SECURITY HQ</h1>
                            <p className="text-[9px] text-gray-500 font-bold uppercase">Tactical Operations Hub V6.7</p>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className={`text-[10px] font-bold ${isConnected ? 'text-green-500' : 'text-red-500 animate-pulse'}`}>
                                {isConnected ? '● 雲端已連線' : '○ 等待連線中'}
                            </span>
                            <div className="stamp-red">重灌完成</div>
                        </div>
                    </header>

                    <nav className="flex bg-neutral-900 border-b border-neutral-800 sticky top-0 z-50">
                        <TabBtn id="handover" label="勤務交接" />
                        <TabBtn id="visitor" label="訪客" />
                        <TabBtn id="k9" label="K9戰犬" />
                        <TabBtn id="manage" label="管理" />
                    </nav>

                    <main className="p-4 flex-1 overflow-y-auto">
                        {/* 這裡會顯示各分頁內容，邏輯與之前 V6.7 相同 */}
                        {activeTab === 'handover' && (
                            <div className="space-y-4 max-w-xl mx-auto">
                                <button onClick={() => {
                                    const note = prompt("交接事項：");
                                    if(note) db.ref('reactLogs').push({ time: new Date().toLocaleString(), note, timestamp: firebase.database.ServerValue.TIMESTAMP });
                                }} className="w-full bg-cyan-500 text-black font-black py-3 rounded-lg shadow-lg">+ 新增交接事項</button>
                                {logs.map(log => (
                                    <div key={log.id} className={`p-4 rounded-lg duty-card ${log.confirmedBy ? 'confirmed-card' : ''}`}>
                                        <div className="text-[10px] text-gray-500 mb-1">{log.time}</div>
                                        <p className="font-bold">{log.note}</p>
                                        {!log.confirmedBy && <button onClick={() => {
                                            const name = prompt("確認者姓名：", "小黑哥");
                                            if(name) db.ref(`reactLogs/${log.id}`).update({confirmedBy: name});
                                        }} className="mt-2 text-xs text-cyan-400 border border-cyan-900 px-2 py-1 rounded">簽署確認</button>}
                                        {log.confirmedBy && <span className="text-[10px] text-emerald-400 font-bold ml-2">✓ 已閱：{log.confirmedBy}</span>}
                                    </div>
                                ))}
                            </div>
                        )}
                        {/* 訪客與K9分頁依照 V6.7 邏輯顯示 */}
                        {activeTab === 'k9' && <div className="text-gray-500 text-center text-xs mt-10">K9 英雄名單加載中...</div>}
                    </main>
                    <footer className="p-4 text-center border-t border-neutral-900 bg-black">
                        <p className="text-[9px] text-gray-700 tracking-widest uppercase font-black">Tactical Cloud - Clean Install 2026</p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
