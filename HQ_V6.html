<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M-SECURITY | HQ æ——è‰¦çµ‚ç«¯ V6.5</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --main-cyan: #00f2ff; --warn-red: #ff4d4f; --bg-dark: #050505; --log-green: #2ecc71; --tab-gray: #222; }
        body { background-color: var(--bg-dark); color: var(--main-cyan); font-family: "Microsoft JhengHei", sans-serif; padding: 0; margin: 0; overflow-x: hidden; }
        
        .header { border-bottom: 2px solid var(--main-cyan); padding: 15px; text-align: center; background: #000; }
        
        /* é ç±¤ç³»çµ± */
        .tab-bar { display: flex; background: #111; border-bottom: 1px solid #333; sticky; top: 0; z-index: 100; }
        .tab-btn { flex: 1; padding: 12px 5px; color: #888; text-align: center; cursor: pointer; font-size: 13px; font-weight: bold; border-right: 1px solid #222; }
        .tab-btn.active { color: var(--main-cyan); background: #1a1a1a; border-bottom: 2px solid var(--main-cyan); }

        .container { padding: 15px; }
        .section { background: #111; padding: 15px; border: 1px solid #333; border-radius: 10px; margin-bottom: 20px; display: none; }
        .section.active { display: block; }
        
        h2 { color: #fff; font-size: 16px; border-left: 5px solid var(--main-cyan); padding-left: 10px; margin-bottom: 15px; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-bottom: 10px; }
        @media (min-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } }
        
        input, textarea, select { background: #1a1a1a; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; font-size: 14px; width: 100%; box-sizing: border-box; }
        .btn { width: 100%; padding: 12px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; margin-top: 5px; font-size: 14px; }
        .btn-blue { background: var(--main-cyan); color: #000; }
        .btn-red { background: var(--warn-red); color: #fff; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th { background: #1a1a1a; color: var(--main-cyan); padding: 10px; text-align: left; border-bottom: 2px solid #333; }
        td { padding: 10px; border-bottom: 1px solid #222; color: #ccc; }
        .scroll-box { max-height: 300px; overflow-y: auto; border: 1px solid #222; background: #000; }
        
        .badge { padding: 2px 5px; border-radius: 3px; font-size: 10px; margin-right: 5px; }
        .badge-emp { border: 1px solid var(--main-cyan); color: var(--main-cyan); }
        .badge-black { border: 1px solid var(--warn-red); color: var(--warn-red); }
        .badge-vip { border: 1px solid #f1c40f; color: #f1c40f; }
    </style>
</head>
<body>

    <div class="header">
        <h1 style="margin:0; font-style: italic; font-size: 18px;">M-SECURITY HQ V6.5</h1>
        <div style="color: #666; font-size: 10px;">MULTIFUNCTIONAL COMMAND CENTER</div>
    </div>

    <div class="tab-bar">
        <div class="tab-btn active" onclick="showTab('tab-monitor')">ç›£æ§</div>
        <div class="tab-btn" onclick="showTab('tab-visitor')">è¨ªå®¢</div>
        <div class="tab-btn" onclick="showTab('tab-handover')">äº¤æ¥</div>
        <div class="tab-btn" onclick="showTab('tab-manage')">éƒ¨ç½²</div>
    </div>

    <div class="container">
        <div id="tab-monitor" class="section active">
            <h2>ğŸ“¡ å¯¦æ™‚æŸ¥è©¢èˆ‡ VIP ç›£æ§</h2>
            <div class="scroll-box">
                <table>
                    <thead><tr><th>æ™‚é–“</th><th>äººå“¡</th><th>æŸ¥è©¢å°è±¡</th></tr></thead>
                    <tbody id="logTable"></tbody>
                </table>
            </div>
            
            <h2 style="margin-top:20px;">ğŸŒŸ VIP è»Šè¼›éƒ¨ç½² (æ‰‹æ©ŸæŸ¥è»Šç‰Œæœƒè‡ªå‹•è­¦å ±)</h2>
            <div class="grid">
                <input type="text" id="vPlate" placeholder="VIP è»Šç‰Œ">
                <input type="text" id="vOwner" placeholder="è»Šä¸»å§“å/è·ä½">
            </div>
            <button class="btn btn-blue" style="background:#f1c40f;" onclick="saveVIP()">è¨»å†Š VIP è»Šè¼›</button>
        </div>

        <div id="tab-visitor" class="section">
            <h2>ğŸ“‹ è¨ªå®¢ç™»è¨˜è¨˜éŒ„</h2>
            <div class="grid">
                <input type="text" id="vName" placeholder="è¨ªå®¢å§“å">
                <input type="number" id="vCount" placeholder="äººæ•¸" value="1">
                <input type="text" id="vComp" placeholder="å…¬å¸è¡Œè™Ÿ">
                <input type="text" id="vTarget" placeholder="å—è¨ªå°è±¡">
            </div>
            <button class="btn btn-blue" onclick="saveVisitor()">ç¢ºèªå…¥å» ç™»è¨˜</button>
            <div class="scroll-box" style="margin-top:15px;">
                <table>
                    <thead><tr><th>å§“å</th><th>å…¥å» </th><th>å‡ºå» </th><th>ç‹€æ…‹</th></tr></thead>
                    <tbody id="visitorTable"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-handover" class="section">
            <h2>ğŸ¤ å‹¤å‹™äº¤æ¥æ—¥èªŒ</h2>
            <textarea id="hNote" rows="4" placeholder="è«‹è¼¸å…¥äº¤æ¥é‡é»ã€ç•°å¸¸äº‹é …ã€ä»£è¾¦ç‰©å“..."></textarea>
            <div class="grid" style="margin-top:10px;">
                <input type="text" id="hOut" placeholder="äº¤ç­äºº">
                <input type="text" id="hIn" placeholder="æ¥ç­äºº">
            </div>
            <button class="btn btn-blue" onclick="saveHandover()">å®Œæˆäº¤æ¥å­˜æª”</button>
            <div class="scroll-box" style="margin-top:15px;">
                <div id="handoverList" style="padding:10px; font-size:13px;"></div>
            </div>
        </div>

        <div id="tab-manage" class="section">
            <h2>ğŸ‘¥ äººå“¡ / é»‘åå–® éƒ¨ç½²</h2>
            <div class="grid">
                <input type="text" id="eID" placeholder="å·¥è™Ÿ">
                <input type="text" id="eName" placeholder="å§“å">
                <input type="text" id="ePlate" placeholder="è»Šç‰Œ">
                <input type="text" id="eReason" placeholder="å‚™è¨»/åŸå› ">
            </div>
            <div class="btn-group" style="display:flex; gap:10px;">
                <button class="btn btn-blue" onclick="saveData('employee_list')">å“¡å·¥</button>
                <button class="btn btn-red" onclick="saveData('blacklist_data')">é»‘åå–®</button>
            </div>
            <div class="scroll-box" style="margin-top:15px;">
                <tbody id="liveTable"></tbody> <table id="fullListTable">
                    <thead><tr><th>é¡å‹</th><th>å§“å</th><th>å·¥è™Ÿ/å‚™è¨»</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="masterTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    // --- åŸºç¤é…ç½® ---
    const firebaseConfig = {
        apiKey: "AIzaSyB2_tKKsVT4kdW7PPkJgI9O7S1YdCWor48",
        databaseURL: "https://factor-security-d1965-default-rtdb.firebaseio.com",
        projectId: "factor-security-d1965",
        appId: "1:864846943143:web:4cfa18cd20d2f712225c82"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // é ç±¤åˆ‡æ›é‚è¼¯
    function showTab(tabId) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // --- è¨ªå®¢ç³»çµ±é‚è¼¯ ---
    function saveVisitor() {
        const name = document.getElementById('vName').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥å§“å");
        const data = {
            name,
            count: document.getElementById('vCount').value,
            company: document.getElementById('vComp').value,
            target: document.getElementById('vTarget').value,
            timeIn: new Date().toLocaleTimeString(),
            leaveTime: "",
            date: new Date().toLocaleDateString()
        };
        db.ref('visitor_logs').push(data).then(() => {
            alert("è¨ªå®¢ç™»è¨˜æˆåŠŸ");
            document.querySelectorAll('#tab-visitor input').forEach(i => i.value = '');
        });
    }

    // --- äº¤æ¥ç³»çµ±é‚è¼¯ ---
    function saveHandover() {
        const note = document.getElementById('hNote').value.trim();
        const hIn = document.getElementById('hIn').value.trim();
        if(!note || !hIn) return alert("è«‹å¡«å¯«äº¤æ¥å…§å®¹èˆ‡æ¥ç­äºº");
        const data = {
            note,
            outUser: document.getElementById('hOut').value,
            inUser: hIn,
            time: new Date().toLocaleString()
        };
        db.ref('handover_logs').push(data).then(() => {
            alert("äº¤æ¥ç´€éŒ„å·²å­˜æª”");
            document.getElementById('hNote').value = '';
        });
    }

    // --- VIP è»Šè¼›é‚è¼¯ ---
    function saveVIP() {
        const plate = document.getElementById('vPlate').value.trim().toUpperCase();
        const owner = document.getElementById('vOwner').value.trim();
        if(!plate) return alert("è«‹è¼¸å…¥è»Šç‰Œ");
        db.ref('vip_vehicles/' + plate).set({ name: owner, plate: plate }).then(() => {
            alert("VIP è»Šè¼›å·²è¨»å†Š");
            document.getElementById('vPlate').value = '';
            document.getElementById('vOwner').value = '';
        });
    }

    // --- èˆŠæœ‰çš„è³‡æ–™å„²å­˜åŠŸèƒ½ ---
    function saveData(path) {
        const id = document.getElementById('eID').value.trim();
        const name = document.getElementById('eName').value.trim();
        if(!name) return alert("âŒ è«‹è¼¸å…¥å§“å");
        const data = { id, name, plate: document.getElementById('ePlate').value.toUpperCase(), reason: document.getElementById('eReason').value, timestamp: new Date().toLocaleString() };
        const ref = (path === 'employee_list') ? db.ref(path + '/' + (id || 'T' + Date.now())) : db.ref(path).push();
        ref.set(data).then(() => alert("åŒæ­¥æˆåŠŸ"));
    }

    // --- å³æ™‚ç›£è½èˆ‡æ›´æ–°è¡¨æ ¼ ---
    
    // ç›£è½æŸ¥è©¢æ—¥èªŒ
    db.ref('search_logs').limitToLast(20).on('value', snap => {
        const tbody = document.getElementById('logTable');
        tbody.innerHTML = '';
        snap.forEach(c => {
            const l = c.val();
            tbody.innerHTML = `<tr><td>${l.time.split(' ')[1]}</td><td style="color:#2ecc71">${l.user}</td><td>${l.query}</td></tr>` + tbody.innerHTML;
        });
    });

    // ç›£è½è¨ªå®¢
    db.ref('visitor_logs').limitToLast(20).on('value', snap => {
        const tbody = document.getElementById('visitorTable');
        tbody.innerHTML = '';
        snap.forEach(c => {
            const v = c.val();
            const isOut = v.leaveTime !== "";
            tbody.innerHTML = `<tr><td>${v.name}</td><td>${v.timeIn}</td><td>${v.leaveTime || '---'}</td><td>${isOut?'å·²é›¢':'åœ¨å ´'}</td></tr>` + tbody.innerHTML;
        });
    });

    // ç›£è½äº¤æ¥
    db.ref('handover_logs').limitToLast(5).on('value', snap => {
        const list = document.getElementById('handoverList');
        list.innerHTML = '';
        snap.forEach(c => {
            const h = c.val();
            list.innerHTML = `<div style="border-bottom:1px solid #333; padding:10px 0;">
                <div style="color:var(--main-cyan)">${h.time}</div>
                <div style="margin:5px 0;">${h.note}</div>
                <div style="color:#888; font-size:11px;">äº¤ç­ï¼š${h.outUser} â” æ¥ç­ï¼š${h.inUser}</div>
            </div>` + list.innerHTML;
        });
    });

    // ç›£è½å…¨åå–® (å“¡å·¥+é»‘åå–®+VIP)
    function refreshMasterTable() {
        const tbody = document.getElementById('masterTableBody');
        tbody.innerHTML = '';
        
        // æŠ“å“¡å·¥
        db.ref('employee_list').once('value', s => {
            s.forEach(c => {
                const i = c.val();
                tbody.innerHTML += `<tr><td><span class="badge badge-emp">å“¡å·¥</span></td><td>${i.name}</td><td>${i.id}</td><td><button onclick="db.ref('employee_list/${c.key}').remove()">åˆª</button></td></tr>`;
            });
        });
        // æŠ“é»‘åå–®
        db.ref('blacklist_data').once('value', s => {
            s.forEach(c => {
                const i = c.val();
                tbody.innerHTML += `<tr><td><span class="badge badge-black">é»‘åå–®</span></td><td>${i.name}</td><td>${i.reason}</td><td><button onclick="db.ref('blacklist_data/${c.key}').remove()">åˆª</button></td></tr>`;
            });
        });
        // æŠ“ VIP
        db.ref('vip_vehicles').once('value', s => {
            s.forEach(c => {
                const i = c.val();
                tbody.innerHTML += `<tr><td><span class="badge badge-vip">VIPè»Š</span></td><td>${i.name}</td><td>${i.plate}</td><td><button onclick="db.ref('vip_vehicles/${c.key}').remove()">åˆª</button></td></tr>`;
            });
        });
    }
    db.ref('employee_list').on('value', refreshMasterTable);
    db.ref('blacklist_data').on('value', refreshMasterTable);
    db.ref('vip_vehicles').on('value', refreshMasterTable);

</script>
</body>
</html>
