<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-SECURITY | HQ æˆ°è¡“çµ‚ç«¯ V6.8</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --cyan: #00f2ff; --warn: #ff4d4f; --bg: #050505; --card: #111; --border: #333; }
        body { background: var(--bg); color: white; font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; overflow-x: hidden; }
        
        /* Header */
        header { background: #000; border-bottom: 2px solid var(--cyan); padding: 12px; text-align: center; }
        header h1 { margin: 0; font-size: 18px; font-style: italic; letter-spacing: 2px; color: var(--cyan); }
        header small { color: #666; font-size: 10px; font-weight: bold; }

        /* Nav Tabs */
        nav { display: flex; background: #111; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .tab-btn { flex: 1; padding: 12px 5px; text-align: center; color: #666; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .tab-btn.active { color: var(--cyan); border-bottom: 2px solid var(--cyan); background: #1a1a1a; }

        /* Container */
        .content { padding: 12px; display: none; }
        .content.active { display: block; }

        /* Cards & UI */
        .section { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 15px; }
        h2 { font-size: 15px; color: #fff; border-left: 4px solid var(--cyan); padding-left: 8px; margin: 0 0 12px 0; }
        
        input, textarea, select { width: 100%; padding: 10px; background: #000; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 14px; box-sizing: border-box; margin-bottom: 8px; outline: none; }
        input:focus { border-color: var(--cyan); }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; }
        .btn-cyan { background: var(--cyan); color: #000; }
        .btn-red { background: var(--warn); color: #fff; }
        .btn-gray { background: #444; color: #ccc; }
        .btn:active { opacity: 0.7; }

        /* List & Tables */
        .scroll-box { max-height: 350px; overflow-y: auto; border: 1px solid #222; background: #000; border-radius: 4px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th { background: #1a1a1a; color: var(--cyan); padding: 8px; text-align: left; position: sticky; top: 0; }
        td { padding: 8px; border-bottom: 1px solid #222; color: #ccc; }

        /* Duty Card ( äº¤æ¥å°ˆç”¨ ) */
        .duty-card { background: #1a1a1a; border-left: 5px solid var(--cyan); padding: 12px; margin-bottom: 10px; border-radius: 4px; position: relative; }
        .duty-card.urgent { border-left-color: var(--warn); }
        .duty-card.confirmed { border-left-color: #10b981; opacity: 0.6; background: #061a14; }
        .badge { font-size: 9px; padding: 2px 4px; border-radius: 3px; font-weight: bold; vertical-align: middle; margin-left: 5px; }
        
        .del-x { position: absolute; top: 10px; right: 10px; color: #444; cursor: pointer; font-size: 16px; }
    </style>
</head>
<body>

<header>
    <h1>M-SECURITY HQ V6.8</h1>
    <small>STABLE CORE | âš¡ æ¥µé€Ÿç©©å®šç‰ˆ</small>
</header>

<nav>
    <div class="tab-btn active" onclick="switchTab('monitor')">ç›£æ§æ—¥èªŒ</div>
    <div class="tab-btn" onclick="switchTab('visitor')">è¨ªå®¢ç´€éŒ„</div>
    <div class="tab-btn" onclick="switchTab('handover')">å‹¤å‹™äº¤æ¥</div>
    <div class="tab-btn" onclick="switchTab('manage')">éƒ¨ç½²ç®¡ç†</div>
</nav>

<div id="monitor" class="content active">
    <h2>ğŸ“¡ æ‰‹æ©Ÿç«¯æŸ¥è©¢å‹•æ…‹</h2>
    <div class="scroll-box">
        <table>
            <thead><tr><th>æ™‚é–“</th><th>äººå“¡</th><th>æŸ¥è©¢å…§å®¹</th></tr></thead>
            <tbody id="realtimeLogs"></tbody>
        </table>
    </div>
</div>

<div id="visitor" class="content">
    <div class="section">
        <h2>å…¥å» ç™»è¨˜</h2>
        <input type="text" id="vName" placeholder="è¨ªå®¢å§“å">
        <input type="text" id="vComp" placeholder="å…¬å¸è¡Œè™Ÿ">
        <button class="btn btn-cyan" onclick="saveVisitor()">ç¢ºèªå…¥å» </button>
    </div>
    <div id="visitorList"></div>
</div>

<div id="handover" class="content">
    <div class="section">
        <button class="btn btn-cyan" onclick="addHandover()">+ æ–°å¢äº¤æ¥äº‹é …</button>
    </div>
    <div id="handoverList"></div>
</div>

<div id="manage" class="content">
    <div class="section">
        <h2>åå–®éƒ¨ç½²</h2>
        <input type="text" id="eID" placeholder="å·¥è™Ÿ">
        <input type="text" id="eName" placeholder="å§“å">
        <input type="text" id="ePlate" placeholder="è»Šç‰Œ">
        <input type="text" id="eReason" placeholder="å–®ä½/å‚™è¨»">
        <div style="display:flex; gap:8px;">
            <button class="btn btn-cyan" onclick="deploy('employee_list')">éƒ¨ç½²å“¡å·¥</button>
            <button class="btn btn-red" onclick="deploy('blacklist_data')">ç™¼å¸ƒé»‘åå–®</button>
        </div>
    </div>
    <div class="scroll-box">
        <table>
            <thead><tr><th>é¡å‹</th><th>å°è±¡</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="masterTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    // --- Firebase é…ç½® ---
    const firebaseConfig = {
        apiKey: "AIzaSyB2_tKKsVT4kdW7PPkJgI9O7S1YdCWor48",
        databaseURL: "https://factor-security-d1965-default-rtdb.firebaseio.com",
        projectId: "factor-security-d1965",
        appId: "1:864846943143:web:4cfa18cd20d2f712225c82"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- åˆ†é åˆ‡æ› ---
    function switchTab(id) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // --- 1. ç›£è½æ‰‹æ©ŸæŸ¥è©¢æ—¥èªŒ ---
    db.ref('search_logs').limitToLast(20).on('value', snap => {
        const tbody = document.getElementById('realtimeLogs');
        tbody.innerHTML = '';
        snap.forEach(c => {
            const l = c.val();
            const time = l.time ? l.time.split(' ')[1] : '---';
            tbody.innerHTML = `<tr><td>${time}</td><td style="color:var(--cyan)">${l.user}</td><td>${l.query}</td></tr>` + tbody.innerHTML;
        });
    });

    // --- 2. è¨ªå®¢ç´€éŒ„é‚è¼¯ ---
    function saveVisitor() {
        const name = document.getElementById('vName').value.trim();
        if(!name) return;
        db.ref('visitor_logs').push({
            name, company: document.getElementById('vComp').value,
            timeIn: new Date().toLocaleTimeString(), leaveTime: "",
            timestamp: Date.now()
        });
        document.getElementById('vName').value = '';
        document.getElementById('vComp').value = '';
    }
    db.ref('visitor_logs').limitToLast(15).on('value', snap => {
        const list = document.getElementById('visitorList');
        list.innerHTML = '<h2>ç›®å‰åœ¨å ´è¨ªå®¢</h2>';
        snap.forEach(c => {
            const v = c.val();
            if(v.leaveTime) return;
            list.innerHTML += `<div class="duty-card">
                <div style="font-weight:bold; font-size:16px;">${v.name}</div>
                <div style="font-size:12px; color:#888;">${v.company} | å…¥å» : ${v.timeIn}</div>
                <button class="btn btn-gray" style="padding:5px; margin-top:8px; font-size:11px;" onclick="db.ref('visitor_logs/${c.key}').update({leaveTime: new Date().toLocaleTimeString()})">ç°½é€€é›¢é–‹</button>
            </div>`;
        });
    });

    // --- 3. äº¤æ¥ç°¿é‚è¼¯ ( æ•´åˆ V3.1 ) ---
    function addHandover() {
        const note = prompt("è«‹è¼¸å…¥äº¤æ¥äº‹é …ï¼š");
        if(!note) return;
        const urgent = confirm("æ¨™è¨»ç‚ºã€Œé‡è¦ã€äº‹é …ï¼Ÿ");
        db.ref('reactLogs').push({
            note, urgent, confirmedBy: null,
            time: new Date().toLocaleString('zh-TW', {hour12:false}),
            timestamp: firebase.database.ServerValue.TIMESTAMP
        });
    }
    db.ref('reactLogs').limitToLast(20).on('value', snap => {
        const list = document.getElementById('handoverList');
        list.innerHTML = '';
        let items = [];
        snap.forEach(c => { items.unshift({key: c.key, ...c.val()}); });
        items.forEach(item => {
            const isConf = item.confirmedBy != null;
            list.innerHTML += `
                <div class="duty-card ${item.urgent?'urgent':''} ${isConf?'confirmed':''}">
                    <span class="del-x" onclick="if(confirm('åˆªé™¤ï¼Ÿ')) db.ref('reactLogs/${item.key}').remove()">âœ•</span>
                    <div style="font-size:10px; color:#666; margin-bottom:5px;">${item.time} 
                        ${item.urgent?'<span class="badge" style="background:var(--warn); color:#fff;">é‡è¦</span>':''}
                        ${isConf?'<span class="badge" style="background:#10b981; color:#fff;">å·²é–±: '+item.confirmedBy+'</span>':''}
                    </div>
                    <div style="font-size:16px; font-weight:bold;">${item.note}</div>
                    ${!isConf ? `<button class="btn btn-cyan" style="padding:5px; margin-top:10px; font-size:12px;" onclick="confirmDuty('${item.key}')">ğŸ–±ï¸ é»æ“Šç°½ç½²ç¢ºèª</button>` : ''}
                </div>`;
        });
    });
    function confirmDuty(key) {
        const name = prompt("è¼¸å…¥ç¢ºèªè€…å§“å", "å°é»‘å“¥");
        if(name) db.ref('reactLogs/'+key).update({ confirmedBy: name });
    }

    // --- 4. éƒ¨ç½²ç®¡ç† ---
    function deploy(path) {
        const name = document.getElementById('eName').value.trim();
        if(!name) return alert("è«‹è¼¸å…¥å§“å");
        const id = document.getElementById('eID').value || Date.now();
        db.ref(path + '/' + id).set({
            name, id, plate: document.getElementById('ePlate').value.toUpperCase(),
            reason: document.getElementById('eReason').value,
            timestamp: new Date().toLocaleString()
        }).then(() => { alert("éƒ¨ç½²æˆåŠŸ"); });
    }
    function updateMaster() {
        const tbody = document.getElementById('masterTableBody');
        tbody.innerHTML = '';
        const fetch = (path, label, color) => {
            db.ref(path).once('value', s => {
                s.forEach(c => {
                    const i = c.val();
                    tbody.innerHTML += `<tr>
                        <td><span style="color:${color}; font-weight:bold;">${label}</span></td>
                        <td>${i.name}</td>
                        <td>${i.reason || i.id || i.plate || '---'}</td>
                        <td><button style="color:var(--warn); background:none; border:none; cursor:pointer;" onclick="if(confirm('åˆªé™¤ï¼Ÿ')) db.ref('${path}/${c.key}').remove()">[åˆªé™¤]</button></td>
                    </tr>`;
                });
            });
        };
        fetch('employee_list', 'å“¡å·¥', 'var(--cyan)');
        fetch('blacklist_data', 'è­¦å‘Š', 'var(--warn)');
    }
    db.ref('employee_list').on('value', updateMaster);
    db.ref('blacklist_data').on('value', updateMaster);

</script>
</body>
</html>
