<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M-SECURITY | HQ æˆ°è¡“çµ‚ç«¯ V6.9</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --cyan: #00f2ff; --warn: #ff4d4f; --bg: #050505; --card: #111; --border: #333; --accent: #27ae60; }
        body { background: var(--bg); color: white; font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; }
        
        /* é ‚éƒ¨èº«åˆ†æ¬„ */
        .user-info { background: #1e293b; color: white; padding: 8px 15px; font-size: 12px; display: flex; justify-content: space-between; border-bottom: 1px solid var(--cyan); }

        header { background: #000; padding: 10px; text-align: center; border-bottom: 1px solid var(--border); }
        header h1 { margin: 0; font-size: 18px; font-style: italic; color: var(--cyan); letter-spacing: 2px; }

        /* åˆ†é å°èˆª */
        nav { display: flex; background: #111; border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; }
        .tab-btn { flex: 1; padding: 12px 5px; text-align: center; color: #666; font-size: 12px; font-weight: bold; cursor: pointer; }
        .tab-btn.active { color: var(--cyan); border-bottom: 2px solid var(--cyan); background: #1a1a1a; }

        .content { padding: 12px; display: none; }
        .content.active { display: block; }

        /* è¬ç”¨å¡ç‰‡ */
        .section { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 12px; margin-bottom: 15px; }
        h2 { font-size: 15px; color: var(--cyan); border-left: 4px solid var(--cyan); padding-left: 8px; margin: 0 0 10px 0; }
        
        input, textarea, select { width: 100%; padding: 10px; background: #000; border: 1px solid #444; color: #fff; border-radius: 4px; font-size: 14px; box-sizing: border-box; margin-bottom: 8px; }
        
        .btn { width: 100%; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-cyan { background: var(--cyan); color: #000; }
        .btn-green { background: var(--accent); color: #fff; }

        /* è¨ªå®¢åˆ—è¡¨æ¸…å–® (ç™½åº•é»‘å­—ï¼Œç¢ºä¿æ¸…æ™°) */
        .visitor-item { background: #fff; border-left: 5px solid var(--accent); padding: 10px; margin-bottom: 10px; border-radius: 5px; color: #333; position: relative; }
        .v-header { display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; margin-bottom: 4px; }
        .v-body { font-size: 12px; color: #555; line-height: 1.5; }
        .checkout-btn { margin-top: 8px; background: #fff; color: var(--accent); border: 1px solid var(--accent); padding: 5px; border-radius: 4px; width: 100%; font-weight: bold; }

        /* æ²è»¸å€ */
        .scroll-box { max-height: 300px; overflow-y: auto; background: #000; border: 1px solid #222; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        td { padding: 8px; border-bottom: 1px solid #222; color: #ccc; }
    </style>
</head>
<body>

<div class="user-info">
    <span onclick="changeName()">å§“åï¼š<span id="userNameDisplay">æœªè¨­å®š</span> âœ</span>
    <span onclick="changeID()">å·¥è™Ÿï¼š<span id="userIDDisplay">æœªè¨­å®š</span> âœ</span>
</div>

<header><h1>M-SECURITY HQ V6.9</h1></header>

<nav>
    <div class="tab-btn active" onclick="switchTab('monitor')">ç›£æ§</div>
    <div class="tab-btn" onclick="switchTab('visitor')">è¨ªå®¢</div>
    <div class="tab-btn" onclick="switchTab('handover')">äº¤æ¥</div>
    <div class="tab-btn" onclick="switchTab('manage')">éƒ¨ç½²</div>
</nav>

<div id="monitor" class="content active">
    <h2>ğŸ“¡ æ‰‹æ©ŸæŸ¥è©¢åŒæ­¥</h2>
    <div class="scroll-box">
        <table><tbody id="realtimeLogs"></tbody></table>
    </div>
</div>

<div id="visitor" class="content">
    <div class="section">
        <h2>è¨ªå®¢ç™»è¨˜å…¥å» </h2>
        <input type="text" id="vName" placeholder="è¨ªå®¢å§“å">
        <div style="display:flex; gap:5px;">
            <input type="number" id="vCount" value="1" style="width:30%">
            <input type="tel" id="vPhone" placeholder="é›»è©±" style="flex:1">
        </div>
        <input type="text" id="vComp" placeholder="å…¬å¸è¡Œè™Ÿ">
        <input type="text" id="vTarget" placeholder="å—è¨ªäººå“¡">
        <textarea id="vReason" rows="1" placeholder="å…¥å» äº‹ç”±"></textarea>
        <button class="btn btn-green" onclick="submitVisitor()">ç¢ºèªç™»è¨˜</button>
    </div>
    <div id="visitorLogList"></div>
</div>

<div id="handover" class="content">
    <div class="section">
        <h2>æ–°å¢äº¤æ¥äº‹é …</h2>
        <textarea id="hNote" rows="2" placeholder="è«‹è¼¸å…¥é‡è¦äº‹é …..."></textarea>
        <button class="btn btn-cyan" onclick="addHandover()">ç™¼å¸ƒäº¤æ¥</button>
    </div>
    <div id="handoverList"></div>
</div>

<div id="manage" class="content">
    <div class="section">
        <h2>åå–®éƒ¨ç½²</h2>
        <input type="text" id="eID" placeholder="å·¥è™Ÿ">
        <input type="text" id="eName" placeholder="å§“å">
        <input type="text" id="eReason" placeholder="å–®ä½ / å‚™è¨»">
        <div style="display:flex; gap:10px;">
            <button class="btn btn-cyan" onclick="deploy('employee_list')">å“¡å·¥</button>
            <button class="btn-red btn" style="flex:1; border-radius:4px;" onclick="deploy('blacklist_data')">é»‘åå–®</button>
        </div>
    </div>
</div>

<script>
    // --- æ ¸å¿ƒé…ç½® ---
    const firebaseConfig = {
        apiKey: "AIzaSyB2_tKKsVT4kdW7PPkJgI9O7S1YdCWor48",
        databaseURL: "https://factor-security-d1965-default-rtdb.firebaseio.com",
        projectId: "factor-security-d1965",
        appId: "1:864846943143:web:4cfa18cd20d2f712225c82"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- èº«åˆ†è¨˜æ†¶ ---
    let userName = localStorage.getItem('guardName') || "";
    let userID = localStorage.getItem('guardID') || "";
    function updateUI() {
        document.getElementById('userNameDisplay').innerText = userName || "æœªè¨­å®š";
        document.getElementById('userIDDisplay').innerText = userID || "æœªè¨­å®š";
    }
    function changeName() { const n = prompt("å§“å", userName); if(n) { userName=n; localStorage.setItem('guardName',n); updateUI(); } }
    function changeID() { const id = prompt("å·¥è™Ÿ", userID); if(id) { userID=id; localStorage.setItem('guardID',id); updateUI(); } }
    window.onload = updateUI;

    // --- åˆ†é åˆ‡æ› ---
    function switchTab(id) {
        document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    // --- 1. ç›£æ§æ—¥èªŒ ---
    db.ref('search_logs').limitToLast(15).on('value', snap => {
        const tb = document.getElementById('realtimeLogs'); tb.innerHTML = '';
        snap.forEach(c => {
            const l = c.val();
            tb.innerHTML = `<tr><td style="color:#666">${l.time.split(' ')[1]}</td><td style="color:var(--cyan)">${l.user}</td><td>æŸ¥ï¼š${l.query}</td></tr>` + tb.innerHTML;
        });
    });

    // --- 2. è¨ªå®¢é‚è¼¯ ---
    function submitVisitor() {
        if(!userName) return alert("è«‹å…ˆé»æ“Šä¸Šæ–¹è¨­å®šå§“å");
        const val = document.getElementById('vName').value;
        if(!val) return;
        const now = new Date();
        const timeIn = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
        db.ref('visitor_logs').push({
            name: val, count: document.getElementById('vCount').value,
            phone: document.getElementById('vPhone').value, company: document.getElementById('vComp').value,
            target: document.getElementById('vTarget').value, reason: document.getElementById('vReason').value,
            timeIn, leaveTime: "", recorder: userName, timestamp: Date.now()
        }).then(() => { alert("ç™»è¨˜æˆåŠŸ"); document.getElementById('vName').value=""; });
    }
    db.ref('visitor_logs').limitToLast(10).on('value', snap => {
        const box = document.getElementById('visitorLogList'); box.innerHTML = '';
        snap.forEach(c => {
            const v = c.val(); const isOut = v.leaveTime !== "";
            box.innerHTML = `
                <div class="visitor-item" style="${isOut?'opacity:0.6':''}">
                    <div class="v-header"><span>${v.name} (${v.count}äºº)</span><span style="color:${isOut?'#999':'#27ae60'}">${isOut?'å·²é›¢å» ':'åœ¨å ´'}</span></div>
                    <div class="v-body">å…¬å¸ï¼š${v.company}<br>æ‹œè¨ªï¼š${v.target} | å…¥ï¼š${v.timeIn}${isOut?' | å‡ºï¼š'+v.leaveTime:''}</div>
                    ${!isOut ? `<button class="checkout-btn" onclick="checkout('${c.key}')">ç°½é€€</button>` : ''}
                </div>` + box.innerHTML;
        });
    });
    function checkout(key) { const t = prompt("å‡ºå» æ™‚é–“", new Date().getHours()+":"+new Date().getMinutes()); if(t) db.ref('visitor_logs/'+key).update({leaveTime:t}); }

    // --- 3. äº¤æ¥é‚è¼¯ ---
    function addHandover() {
        const n = prompt("äº¤æ¥äº‹é …"); if(n) db.ref('reactLogs').push({ note:n, time:new Date().toLocaleString(), confirmedBy:null, timestamp:Date.now() });
    }
    db.ref('reactLogs').limitToLast(10).on('value', snap => {
        const box = document.getElementById('handoverList'); box.innerHTML = '';
        snap.forEach(c => {
            const h = c.val(); const isC = h.confirmedBy != null;
            box.innerHTML = `
                <div class="section" style="border-left:5px solid ${isC?'#27ae60':'var(--cyan)'}; opacity:${isC?0.6:1}">
                    <div style="font-size:10px; color:#666;">${h.time}</div>
                    <div style="font-weight:bold; margin:5px 0;">${h.note}</div>
                    ${!isC ? `<button class="btn btn-cyan" style="padding:5px; font-size:11px;" onclick="confH('${c.key}')">ç°½ç½²ç¢ºèª</button>` : `<small style="color:#27ae60">âœ“ å·²é–±: ${h.confirmedBy}</small>`}
                    <span style="float:right; cursor:pointer;" onclick="db.ref('reactLogs/${c.key}').remove()">âœ•</span>
                </div>` + box.innerHTML;
        });
    });
    function confH(key) { const n = prompt("å§“å", userName); if(n) db.ref('reactLogs/'+key).update({confirmedBy:n}); }

    // --- 4. éƒ¨ç½² ---
    function deploy(path) {
        const n = document.getElementById('eName').value; if(!n) return;
        db.ref(path + '/' + (document.getElementById('eID').value || Date.now())).set({
            name: n, id: document.getElementById('eID').value, reason: document.getElementById('eReason').value
        }).then(() => alert("æˆåŠŸ"));
    }
</script>
</body>
</html>
